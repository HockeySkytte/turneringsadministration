/* eslint-disable no-console */

const fs = require('fs');
const path = require('path');

function normalizeNiveau(raw) {
  const s = String(raw ?? '').trim();
  if (!s) return null;
  const m = s.match(/^(\d{1,2})\s*[,\.]\s*(\d{1,2})$/);
  if (!m) return null;
  const a = String(Number(m[1])).padStart(2, '0');
  const b = String(Number(m[2])).padStart(2, '0');
  return `${a},${b}`;
}

function parseBeeptestCsv(csvText) {
  const lines = csvText.split(/\r?\n/).filter(Boolean);
  const header = lines.shift();
  if (!header) throw new Error('Beeptest.csv is empty');

  const rows = [];
  for (const line of lines) {
    // Format: Decimal,"Niveau",Kondital
    // Decimal and Kondital use dot as decimal separator; Niveau uses comma.
    const fields = [];
    let current = '';
    let inQuotes = false;
    for (let i = 0; i < line.length; i += 1) {
      const ch = line[i];
      if (ch === '"') {
        if (inQuotes && line[i + 1] === '"') {
          current += '"';
          i += 1;
          continue;
        }
        inQuotes = !inQuotes;
        continue;
      }
      if (ch === ',' && !inQuotes) {
        fields.push(current);
        current = '';
        continue;
      }
      current += ch;
    }
    fields.push(current);

    if (fields.length < 3) continue;

    const decimal = Number(fields[0]);
    const niveau = normalizeNiveau(fields[1]);
    const kondital = Number(fields[2]);

    if (!Number.isFinite(decimal) || !Number.isFinite(kondital) || !niveau) continue;

    rows.push({ decimal, niveau, kondital });
  }

  rows.sort((a, b) => a.decimal - b.decimal);
  return rows;
}

function main() {
  const repoRoot = path.join(__dirname, '..');
  const csvPath = path.join(repoRoot, 'Testdata', 'Beeptest.csv');
  const outPath = path.join(repoRoot, 'src', 'lib', 'beepTestTable.ts');

  const csvText = fs.readFileSync(csvPath, 'utf8').trim();
  const rows = parseBeeptestCsv(csvText);

  const out = [];
  out.push('// This file is generated by scripts/generate-beep-table.cjs');
  out.push('// Do not edit manually. Update Testdata/Beeptest.csv and re-run the script.');
  out.push('');
  out.push('export type BeepTableRow = { decimal: number; niveau: string; kondital: number };');
  out.push('export const BEEP_TABLE: BeepTableRow[] = ' + JSON.stringify(rows, null, 2) + ' as const;');
  out.push('');
  out.push('const BY_NIVEAU = new Map<string, BeepTableRow>(BEEP_TABLE.map((r) => [r.niveau, r]));');
  out.push('');
  out.push('export function normalizeNiveau(input: unknown): string | null {');
  out.push('  const raw = String(input ?? "").trim();');
  out.push('  if (!raw) return null;');
  out.push('  const m = raw.match(/^(\\d{1,2})\\s*[,\\.]\\s*(\\d{1,2})$/);');
  out.push('  if (!m) return null;');
  out.push('  const a = String(Number(m[1])).padStart(2, "0");');
  out.push('  const b = String(Number(m[2])).padStart(2, "0");');
  out.push('  return `${a},${b}`;');
  out.push('}');
  out.push('');
  out.push('export function rowByNiveau(niveau: unknown): BeepTableRow | null {');
  out.push('  const n = normalizeNiveau(niveau);');
  out.push('  if (!n) return null;');
  out.push('  return BY_NIVEAU.get(n) ?? null;');
  out.push('}');
  out.push('');
  out.push('export function closestRowByDecimal(decimal: number): BeepTableRow | null {');
  out.push('  if (!Number.isFinite(decimal)) return null;');
  out.push('  const arr = BEEP_TABLE;');
  out.push('  if (arr.length === 0) return null;');
  out.push('  let lo = 0, hi = arr.length - 1;');
  out.push('  while (lo <= hi) {');
  out.push('    const mid = (lo + hi) >> 1;');
  out.push('    const v = arr[mid].decimal;');
  out.push('    if (v === decimal) return arr[mid];');
  out.push('    if (v < decimal) lo = mid + 1; else hi = mid - 1;');
  out.push('  }');
  out.push('  const a = arr[Math.max(0, Math.min(arr.length - 1, hi))];');
  out.push('  const b = arr[Math.max(0, Math.min(arr.length - 1, lo))];');
  out.push('  if (!a) return b ?? null;');
  out.push('  if (!b) return a ?? null;');
  out.push('  return Math.abs(a.decimal - decimal) <= Math.abs(b.decimal - decimal) ? a : b;');
  out.push('}');
  out.push('');
  out.push('export function decimalFromResultText(resultText: unknown): number | null {');
  out.push('  const row = rowByNiveau(resultText);');
  out.push('  return row ? row.decimal : null;');
  out.push('}');
  out.push('');
  out.push('export function konditalFromResultText(resultText: unknown): number | null {');
  out.push('  const row = rowByNiveau(resultText);');
  out.push('  return row ? row.kondital : null;');
  out.push('}');
  out.push('');
  out.push('export const BEEP_BOUNDS = (() => {');
  out.push('  const min = rowByNiveau("08,01");');
  out.push('  const max = rowByNiveau("17,14");');
  out.push('  if (!min || !max) return null;');
  out.push('  return {');
  out.push('    minNiveau: min.niveau,');
  out.push('    maxNiveau: max.niveau,');
  out.push('    minDecimal: min.decimal,');
  out.push('    maxDecimal: max.decimal,');
  out.push('    minKondital: min.kondital,');
  out.push('    maxKondital: max.kondital,');
  out.push('  };');
  out.push('})();');
  out.push('');

  fs.mkdirSync(path.dirname(outPath), { recursive: true });
  fs.writeFileSync(outPath, out.join('\n'), 'utf8');

  console.log(`Generated ${path.relative(repoRoot, outPath)} (${rows.length} rows)`);
}

main();
